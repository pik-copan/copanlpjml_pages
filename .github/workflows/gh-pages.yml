name: Hugo CI with Documentation

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test Hugo build (without docs)
        run: |
          echo "Testing Hugo build without external docs..."
          hugo --logLevel info
          
      - name: Verify output
        run: |
          ls -la public/
          echo "âœ… Hugo build successful"

  pages:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd themes/toha && npm ci && cd ../..

      - name: Create docs redirect page
        run: |
          mkdir -p static/docs
          cat > static/docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - copan:LPJmL</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f2f3e3;
            color: #344643;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            color: #e37222;
            margin-bottom: 2rem;
        }
        .redirect-notice {
            background: #e1f5fe;
            border: 1px solid #81d4fa;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .link {
            color: #e37222;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.2rem;
            background: #e37222;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            display: inline-block;
            margin: 1rem;
        }
        .link:hover {
            background: #91cdcd;
            color: white;
        }
        .info {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
    </style>
    <script>
        // Auto-redirect after 3 seconds
        setTimeout(function() {
            window.location.href = 'https://pycopanlpjml.readthedocs.io/en/latest/';
        }, 3000);
    </script>
</head>
<body>
    <div class="container">
        <h1>copan:LPJmL Documentation</h1>
        
        <div class="redirect-notice">
            <p><strong>Redirecting to the official documentation...</strong></p>
            <p>You will be automatically redirected in 3 seconds.</p>
        </div>
        
        <div class="info">
            <p>Access the complete documentation at:</p>
            <a href="https://pycopanlpjml.readthedocs.io/en/latest/" class="link">ðŸ“š View Full Documentation</a>
        </div>
    </div>
</body>
</html>
EOF
          echo "Created docs redirect page"

      - name: Build Hugo site
        env:
          HUGO_ENV: production
        run: |
          echo "Building Hugo site with documentation..."
          hugo --logLevel info

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
